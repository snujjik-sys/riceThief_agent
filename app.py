# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1v28VH5N7cAp9Kl8gkJj6S2EXpwntXyl5
"""

import streamlit as st
import agent_logic

st.set_page_config(page_title="ìì·¨ìƒ ë°¥ì„ ìƒ", page_icon="ğŸ³")

st.title("ğŸ³ ìì·¨ìƒì„ ìœ„í•œ ì—„ë§ˆ ë°¥ì„ ìƒ")
st.caption("ì—„ë§ˆ! ëƒ‰ì¥ê³ ì— ìˆëŠ” ê±¸ë¡œ ë­ í•´ë¨¹ì„ê¹Œ?")

# 3. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨í•˜ê¸° ì „ê¹Œì§€ ëŒ€í™” ë‚´ìš© ì €ì¥ ë° ê¸°ì–µ

if "messages" not in st.session_state:
    st.session_state.messages = []
    # ì²« ì¸ì‚¬ë§ ì¶”ê°€
    st.session_state.messages.append({"role": "assistant", "content": "ìš°ë¦¬ ë”¸/ì•„ë“¤ ì™”ì–´? ë°¥ì€ ì±™ê²¨ ë¨¹ì—ˆë‹ˆ? ë­ í•´ì¤„ê¹Œ?"})

# DBì™€ LLM ë¡œë“œ
if "agent_loaded" not in st.session_state:
    try:
        db, llm = agent_logic.get_agent_components()
        st.session_state.db = db
        st.session_state.llm = llm
        st.session_state.agent_loaded = True
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        st.stop()

# ì±„íŒ… í™”ë©´ êµ¬í˜„

for msg in st.session_state.messages:
    if msg["role"] == "user":
        st.chat_message("user").write(msg["content"])
    else:
        st.chat_message("assistant").write(msg["content"])

# ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬

if prompt := st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ê³„ë€ìœ¼ë¡œ ë­ í•´ë¨¹ì„ê¹Œ?)"):

    # 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ ë° ì €ì¥
    st.chat_message("user").write(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # 2. ì—ì´ì „íŠ¸ì—ê²Œ ë‹µë³€ ìš”ì²­ (Multi-turnì„ ìœ„í•´ ê¸°ë¡ ì „ë‹¬)
    # í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ê¸°ë¡ì„ (User, AI) íŠœí”Œ í˜•íƒœë¡œ ë³€í™˜
    chat_history = []
    for msg in st.session_state.messages[:-1]:
        role = "ìì‹" if msg["role"] == "user" else "ì—„ë§ˆ"
        chat_history.append((role, msg["content"]))

    with st.spinner("ì—„ë§ˆê°€ ë ˆì‹œí”¼ ë…¸íŠ¸ ì°¾ëŠ” ì¤‘..."):
        # agent_logic í•¨ìˆ˜ í˜¸ì¶œ
        response_text, retrieved_doc = agent_logic.generate_response(
            st.session_state.db,
            st.session_state.llm,
            prompt,
            chat_history
        )

    # 3. AI ë‹µë³€ í™”ë©´ì— í‘œì‹œ ë° ì €ì¥
    st.chat_message("assistant").write(response_text)
    st.session_state.messages.append({"role": "assistant", "content": response_text})

    # RAGê°€ ì–´ë–¤ ë¬¸ì„œë¥¼ ì°¾ì•˜ëŠ”ì§€ ê¶ê¸ˆí•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    with st.expander("ì—„ë§ˆê°€ ì°¸ê³ í•œ ë ˆì‹œí”¼ ë…¸íŠ¸ ë³´ê¸°"):
        st.info(retrieved_doc)